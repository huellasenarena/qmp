name: SA smoke test (Docs access)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sa-smoketest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install google-api-python-client google-auth google-auth-oauthlib
          fi

      - name: Write service account keyfile
        env:
          QMP_GDOCS_SA_KEY_JSON: ${{ secrets.QMP_GDOCS_SA_KEY_JSON }}
        run: |
          mkdir -p .secrets
          python - <<'PY'
          import os, pathlib
          key = os.environ["QMP_GDOCS_SA_KEY_JSON"]
          p = pathlib.Path(".secrets/sa.json")
          p.write_text(key, encoding="utf-8")
          print("Wrote", p)
          PY
          chmod 600 .secrets/sa.json

      - name: Verify creds type + list tabs
        env:
          QMP_GDOCS_SA_KEYFILE: ${{ github.workspace }}/.secrets/sa.json
          QMP_DOC_ID: "1s_n58zfRhYd1caq6QldCF99Kke3QEbPvLfl-57Q-1j0"
          PYTHONPATH: ${{ github.workspace }}/scripts
        run: |
          python -c "from _gdocs_auth import get_creds; c=get_creds(); print('CREDS_TYPE=', type(c).__module__ + '.' + type(c).__name__)"
          python - <<'PY'
          import os
          from googleapiclient.discovery import build
          from _gdocs_auth import get_creds

          doc_id = os.environ["QMP_DOC_ID"]
          s = build("docs","v1", credentials=get_creds())
          d = s.documents().get(documentId=doc_id, includeTabsContent=True).execute()

          print("DOC_TITLE=", d.get("title"))
          print("TABS=")
          for t in d.get("tabs", []):
              print("-", (t.get("tabProperties", {}) or {}).get("title"))
          PY

